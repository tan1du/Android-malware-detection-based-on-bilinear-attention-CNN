import sys
import numpy as np
from androguard.core.bytecodes.apk import APK
from PIL import Image
import os
def get_bytes(apk: APK, file_type: str) -> bytes:
    assert file_type in {".dex", ".arsc", ".xml"}
    for f in apk.get_files():
        if f.endswith(file_type):
            yield apk.get_file(f)

def generate_png(apk: APK, filename: str, file_type: str):
    assert file_type in {".dex", ".arsc", ".xml"}
    stream = bytes()
    for s in get_bytes(apk, file_type):
        stream += s
    current_len = len(stream)
    image = Image.frombytes(mode='L', size=(128, current_len//128), data=stream)
    image = image.resize((128, 128), resample=Image.BILINEAR)
    filename = filename.split('.')[0]
    # image.save(f"{filename}{file_type}.png")

    return image

def generate_color_image(apk, filename):
    dex_img = generate_png(apk, filename, '.dex')
    xml_img = generate_png(apk, filename, '.xml')
    arsc_img = generate_png(apk, filename, '.arsc')
    # try:
    #     arsc_img  = generate_png(apk, filename, '.arsc')
    # except:
    #     arsc_img = np.zeros((128, 128))
    dex_img, arsc_img, xml_img = np.array(dex_img), np.array(arsc_img), np.array(xml_img)
    H, W = dex_img.shape
    image = np.zeros((H, W, 3))
    image[:, :, 0] = dex_img
    image[:, :, 1] = arsc_img
    image[:, :, 2] = xml_img
    filename = filename.split('.')[0]
    color_image = Image.fromarray(image.astype(np.uint8))
    color_image.save(f"{filename}.color.png")
    

if __name__ == "__main__":
    if __name__ == "__main__":
        path = "E:/apk3/"
        path_files = os.listdir(path)
        for file in path_files:
            filen = file
            destination_folder = path
            # file_path = path + "/" + file
            filename = destination_folder + filen
            try:
                apk = APK(filename)

            except:
                continue
            try:
                generate_color_image(apk, filename)
            except:
                continue


# if __name__ == "__main__":
#     if len(sys.argv) != 2:
#         raise Exception("[!] Usage: python3 apk2images.py APK")
#     else:
#         filename = sys.argv[1]
#     try:
#         apk = APK(filename)
#         generate_color_image(apk, filename)
#         print(f"Images successfully generated from {filename}")
#     except Exception as e:
#         print("[!] An exception occured with: {}".format(filename))
#         print("Exception: {}".format(e))